name: CI

on:
  push:
    branches:
      - master
      - main
      - feat/**
      - feature/**
  pull_request:
    branches:
      - master
      - main
      - feat/**
      - feature/**
  schedule:
    # Run at 03:30 UTC on the 1st of every month
    - cron: "30 3 1 * *"

jobs:
  check-links:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Extract homepage URLs from codes.json
        run: |
          jq -r 'to_entries[] | .value.homepage // empty' src/data/codes.json | sed '/^$/d' > urls.txt
          echo "Found $(wc -l < urls.txt) URLs"

      - name: Link Checker
        uses: lycheeverse/lychee-action@v2.5.0
        with:
          args: >-
            --verbose --timeout 40 --insecure 
            --exclude "https://www.msg.chem.iastate.edu/"
            --exclude "http://openmopac.net/"
            urls.txt
          fail: true

  test:
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

  build:
    runs-on: ubuntu-latest
    needs: test
    env:
      CI: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
